<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tanaka Playground - Popup</title>
    <link rel="stylesheet" href="styles/design-system.css" />
    <style>
      /* Page-specific styles only */
      .popup-simulator {
        display: flex;
        gap: var(--space-3xl);
        align-items: flex-start;
        justify-content: center;
      }

      @media (max-width: 1024px) {
        .popup-simulator {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="simulator-container">
      <div class="simulator-header">
        <h1 class="simulator-title">Popup Interface</h1>
        <p class="simulator-subtitle">Interactive extension popup simulator with real-time state management</p>
      </div>

      <div class="simulator-controls">
        <div class="controls-row">
          <div class="control-group">
            <label class="control-label">State:</label>
            <button class="state-button active" data-state="normal" aria-pressed="true">Normal</button>
            <button class="state-button" data-state="loading" aria-pressed="false">Loading</button>
            <button class="state-button" data-state="empty" aria-pressed="false">Empty</button>
            <button class="state-button" data-state="error" aria-pressed="false">Error</button>
            <button class="state-button" data-state="searching" aria-pressed="false">Searching</button>
          </div>
        </div>
        <div class="controls-row">
          <div class="control-group flex-1">
            <label class="control-label">Search:</label>
            <input
              type="text"
              class="control-input"
              id="searchControl"
              placeholder="Enter search term..."
              aria-label="Search term"
            />
          </div>
        </div>
        <div class="controls-row">
          <div class="control-group">
            <label class="control-label">Workspaces:</label>
            <button class="state-button" data-workspaces="3" aria-pressed="false">3 workspaces</button>
            <button class="state-button" data-workspaces="0" aria-pressed="false">No workspaces</button>
            <button class="state-button" data-workspaces="15" aria-pressed="true">Many workspaces</button>
          </div>
        </div>
      </div>

      <div class="popup-simulator">
        <div class="extension-frame extension-frame--popup">
          <div class="popup-container" id="popupContainer">
            <!-- Popup content will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <script src="mock-data.js"></script>
    <script>
      class PopupSimulator extends _SimulatorState {
        constructor() {
          super();
          this.container = document.getElementById("popupContainer");
          if (!this.container) {
            console.error("PopupSimulator: Container element 'popupContainer' not found");
            return;
          }
          this.setupControls();
          this.render();
        }

        setupControls() {
          // State buttons
          document.querySelectorAll("[data-state]").forEach((btn) => {
            btn.addEventListener("click", () => {
              document.querySelectorAll("[data-state]").forEach((b) => {
                b.classList.remove("active");
                b.setAttribute("aria-pressed", "false");
              });
              btn.classList.add("active");
              btn.setAttribute("aria-pressed", "true");
              this.setState(btn.dataset.state);
            });
          });

          // Workspace count buttons
          document.querySelectorAll("[data-workspaces]").forEach((btn) => {
            btn.addEventListener("click", () => {
              document.querySelectorAll("[data-workspaces]").forEach((b) => {
                b.classList.remove("active");
                b.setAttribute("aria-pressed", "false");
              });
              btn.classList.add("active");
              btn.setAttribute("aria-pressed", "true");
              const count = parseInt(btn.dataset.workspaces);
              this.setWorkspaceCount(count);
            });
          });

          // Set many workspaces by default to test scrolling
          this.setWorkspaceCount(15);

          // Search control
          const searchControl = document.getElementById("searchControl");
          searchControl.addEventListener("input", (e) => {
            this.setSearchQuery(e.target.value);
          });
        }

        setWorkspaceCount(count) {
          if (count === 0) {
            this.workspaces = [];
            this.setState("empty");
          } else if (count === 15) {
            // Generate many workspaces
            this.workspaces = [
              ...mockWorkspaces,
              ...Array.from({ length: 12 }, (_, i) => ({
                id: `workspace-${i + 4}`,
                name: `Project ${i + 4}`,
                tabCount: Math.floor(Math.random() * 20) + 1,
                status: ["synced", "syncing", "error"][Math.floor(Math.random() * 3)],
                isOpen: Math.random() > 0.5,
                lastChange: `${Math.floor(Math.random() * 60) + 1}m ago`,
              })),
            ];
            this.setState("normal");
          } else {
            this.workspaces = mockWorkspaces.slice(0, count);
            this.setState("normal");
          }
        }

        escapeHtml(unsafe) {
          if (!unsafe) return "";
          return unsafe
            .toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        renderHeader() {
          return `
                    <div class="popup-header">
                        <h1 class="page-title">Tanaka</h1>
                        <button class="button--icon" aria-label="Settings"><span class="icon icon--gear"></span></button>
                    </div>
                `;
        }

        render() {
          switch (this.currentState) {
            case "loading":
              this.renderLoading();
              break;
            case "empty":
              this.renderEmpty();
              break;
            case "error":
              this.renderError();
              break;
            case "searching":
              this.renderSearch();
              break;
            default:
              this.renderNormal();
          }

          // Attach event listeners after rendering
          this.attachSearchListeners();
        }

        attachSearchListeners() {
          // Attach search input listener
          const searchInput = document.getElementById("popupSearchInput");
          if (searchInput) {
            searchInput.addEventListener("input", (e) => {
              this.setSearchQuery(e.target.value);
            });
          }

          // Attach clear button listener
          const clearBtn = document.getElementById("clearSearchBtn");
          if (clearBtn) {
            clearBtn.addEventListener("click", () => {
              this.setSearchQuery("");
            });
          }
        }

        renderLoading() {
          this.container.innerHTML = `
                    ${this.renderHeader()}
                    <div class="popup-body">
                        <div class="empty-state">
                            <div class="animate-pulse">üîÑ</div>
                            <p class="mt-xs">Loading...</p>
                        </div>
                    </div>
                `;
        }

        renderEmpty() {
          this.container.innerHTML = `
                    ${this.renderHeader()}
                    <div class="popup-body">
                        <div class="empty-state">
                            <h3>Welcome to Tanaka!</h3>
                            <p>Track browser windows to sync<br>tabs across devices.</p>
                        </div>
                        <div class="popup-section">
                            <h2 class="section-title">Current Window</h2>
                            <button class="button button--primary w-full">
                                <span class="icon icon--play-circle"></span>
                                Track as Workspace
                            </button>
                        </div>
                        <div class="popup-section">
                            <button class="button button--secondary w-full mb-sm">
                                <span class="icon icon--plus-circle"></span>
                                New Workspace
                            </button>
                        </div>
                    </div>
                `;
        }

        renderError() {
          this.container.innerHTML = `
                    ${this.renderHeader()}
                    <div class="popup-body">
                        <div class="popup-section bg-error-light border-error">
                            <div class="text-error text-sm flex items-center gap-sm">
                                ‚ö†Ô∏è Connection lost - working offline
                                <button class="button button--secondary ml-auto py-xs px-sm text-xs">
                                    üîÑ Retry Now
                                </button>
                            </div>
                        </div>
                        ${this.renderSearchBar()}
                        ${this.renderWorkspaceList(true)}
                    </div>
                `;
        }

        renderSearch() {
          const results = _mockSearchResults[this.searchQuery.toLowerCase()] || { workspaces: [] };

          this.container.innerHTML = `
                    ${this.renderHeader()}
                    <div class="popup-body">
                        ${this.renderSearchBar()}
                        <div class="popup-section">
                            <h2 class="section-title">Search Results</h2>
                            ${results.workspaces.length > 0 ? this.renderSearchResults(results) : this.renderNoResults()}
                        </div>
                    </div>
                `;
        }

        renderNormal() {
          this.container.innerHTML = `
                    ${this.renderHeader()}
                    <div class="popup-body">
                        ${this.renderSearchBar()}
                        ${this.renderWorkspaceList()}
                        <div class="popup-section">
                            <h2 class="section-title">Current Window</h2>
                            <button class="button button--primary w-full">
                                <span class="icon icon--play-circle"></span>
                                Track as Workspace
                            </button>
                        </div>
                        <div class="popup-section">
                            <button class="button button--secondary w-full mb-sm">
                                <span class="icon icon--plus-circle"></span>
                                New Workspace
                            </button>
                            <button class="button button--secondary w-full">
                                <span class="icon icon--list-bullets"></span>
                                Manage Workspaces
                            </button>
                        </div>
                    </div>
                `;
        }

        renderSearchBar() {
          return `
                    <div class="popup-section">
                        <div class="search-container">
                            <span class="search-icon">üîç</span>
                            <input type="text" class="search-input" id="popupSearchInput" placeholder="Search workspaces and tabs..." value="${this.searchQuery}" aria-label="Search workspaces and tabs">
                            ${this.searchQuery ? '<button class="clear-button" id="clearSearchBtn" aria-label="Clear search">‚úï</button>' : ""}
                        </div>
                    </div>
                `;
        }

        renderWorkspaceList(isOffline = false) {
          if (!Array.isArray(this.workspaces) || this.workspaces.length === 0) {
            return "";
          }

          const workspaceItems = this.workspaces
            .filter((workspace) => workspace && workspace.id && workspace.name)
            .map((workspace) => {
              const statusText = isOffline ? "Connection lost" : workspace.lastChange || "Unknown";
              const statusClass = isOffline ? "error" : workspace.status || "synced";
              const tabCount = workspace.tabCount || 0;
              const isOpen = Boolean(workspace.isOpen);

              return `
                        <div class="workspace-item">
                            <div class="workspace-header">
                                <span class="status-dot status-dot--${statusClass}"></span>
                                <h3 class="workspace-name">${this.escapeHtml(workspace.name)}</h3>
                                <span class="meta-text">${tabCount} tabs</span>
                            </div>
                            <div class="workspace-footer">
                                <div class="workspace-status">
                                    <span class="icon icon--${isOpen ? "folder-open" : "folder"}"></span>
                                    <span class="ml-xs">${statusText}</span>
                                </div>
                                <div class="workspace-actions">
                                    ${
                                      isOpen
                                        ? '<button class="button button--secondary">Switch to</button><button class="button button--secondary">Close</button>'
                                        : '<button class="button button--secondary">Open</button>'
                                    }
                                </div>
                            </div>
                        </div>
                    `;
            })
            .join("");

          return `
                    <div class="popup-section">
                        <h2 class="section-title">My Workspaces</h2>
                        <div class="workspace-list">
                            ${workspaceItems}
                        </div>
                    </div>
                `;
        }

        renderSearchResults(results) {
          return results.workspaces
            .map((result) => {
              const workspace = result.workspace;
              const matchCount = result.matchingTabs.length;
              const totalCount = result.totalTabs || matchCount;

              return `
                        <div class="workspace-item">
                            <div class="workspace-header">
                                <span class="status-dot status-dot--${workspace.status}"></span>
                                <h3 class="workspace-name">${this.escapeHtml(workspace.name)}</h3>
                                <span class="meta-text">${matchCount} matching tab${matchCount !== 1 ? "s" : ""}</span>
                            </div>
                            <div class="pl-lg mt-xs">
                                <div class="workspace-status">
                                    <span class="icon icon--${workspace.isOpen ? "folder-open" : "folder"}"></span>
                                </div>
                                ${result.matchingTabs
                                  .slice(0, 3)
                                  .map(
                                    (tab) => `
                                    <div class="text-sm text-secondary my-2px pl-lg">
                                        üìÑ ${this.escapeHtml(tab.title)}
                                    </div>
                                `
                                  )
                                  .join("")}
                                ${
                                  totalCount > 3
                                    ? `
                                    <div class="text-sm text-secondary my-2px pl-lg">
                                        ‚ñº Show ${totalCount - 3} more ... (${totalCount} total)
                                    </div>
                                `
                                    : ""
                                }
                            </div>
                        </div>
                    `;
            })
            .join("");
        }

        renderNoResults() {
          return `
                    <div class="empty-state">
                        <h3>No results found for<br>"${this.escapeHtml(this.searchQuery)}"</h3>
                    </div>
                `;
        }
      }

      // Initialize simulator
      new PopupSimulator();
    </script>
  </body>
</html>
